<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<!-- SQL Mapping -->
<mapper namespace="com.ai.board.dao.BoardMapper">
	<!-- 게시판 조회 -->
	<select id="selectBoardList" parameterType="com.ai.board.vo.BoardSearchVo" resultType="com.ai.board.vo.BoardVo">
		SELECT BB.BOARD_ID
			 , F_GET_CODE_NAME('BO001', BB.BOARD_GUBUN) AS BOARD_NM
			 , BB.FST_CRER_ID
			 , IFNULL((SELECT USER_NM FROM CU_USER WHERE USER_ID = BB.FST_CRER_ID), BB.FST_CRER_ID) AS FST_CRER_NM
			 , DATE_FORMAT(BB.FST_CRE_DTM, '%Y-%m-%d %h:%i') AS FST_CRE_DTM
			 , BB.AUDIT_ID
			 , IFNULL((SELECT USER_NM FROM CU_USER WHERE USER_ID = BB.AUDIT_ID), BB.AUDIT_ID) AS AUDIT_NM
		     , DATE_FORMAT(BB.AUDIT_DTM, '%Y-%m-%d %h:%i') AS AUDIT_DTM
			 , BB.IMPO_YN
			 , BB.BOARD_TIT
			 , BB.BOARD_CTT
			 , IF((SELECT BB.FST_CRE_DTM BETWEEN DATE(DATE_ADD(NOW(), INTERVAL -#{ssDateControlDay} DAY)) AND NOW() FROM DUAL) = '1', 'Y', 'N') AS NEW_YN
			 , IF(IFNULL(BBF.FILE_ID, '') = '', 'N', 'Y') AS FILE_YN
			 , BBF.FILE_CNT
			 , BBF.FILE_NM
	 		 , BBF.FILE_OG_NM
		  FROM BO_BOARD BB
	      LEFT JOIN (
	     	SELECT BOARD_ID
			      , BOARD_GUBUN
			      , FILE_ID
			      , COUNT(*) AS FILE_CNT
			      , GROUP_CONCAT(FILE_NM ORDER BY FILE_ID ASC SEPARATOR ',')  AS FILE_NM
			      , GROUP_CONCAT(FILE_OG_NM ORDER BY FILE_ID ASC SEPARATOR ',')  AS FILE_OG_NM
			    FROM BO_BOARD_FILE
			    GROUP BY BOARD_ID, BOARD_GUBUN
	      ) BBF ON BB.BOARD_ID = BBF.BOARD_ID AND BB.BOARD_GUBUN = BBF.BOARD_GUBUN
		 WHERE 1 = 1
		   AND BB.DEL_YN = 'N'
		   AND BB.BOARD_GUBUN = #{searchBoardGubun}
		   <if test='@org.apache.commons.lang3.StringUtils@isNotEmpty(searchValue)'>
			   <if test='@org.apache.commons.lang3.StringUtils@equals(searchKey, "01")'>
				   AND CONCAT(BB.BOARD_TIT, BB.BOARD_CTT) LIKE CONCAT('%', #{searchValue}, '%')
			   </if>
			   <if test='@org.apache.commons.lang3.StringUtils@equals(searchKey, "02")'>
				   AND BB.BOARD_TIT LIKE CONCAT('%', #{searchValue}, '%')
			   </if>
			   <if test='@org.apache.commons.lang3.StringUtils@equals(searchKey, "03")'>
				   AND BB.BOARD_CTT LIKE CONCAT('%', #{searchValue}, '%')
			   </if>
		   </if>
		 ORDER BY IF(BB.IMPO_YN = 'Y', 1, 2), FST_CRE_DTM DESC
	</select>

	<resultMap id="boardMap" type="com.ai.board.vo.BoardVo">
        <id property="boardId" column="BOARD_ID" javaType="java.lang.String"/>
        <result property="boardNm" column="BOARD_NM" javaType="java.lang.String"/>
        <result property="fstCrerId" column="FST_CRER_ID" javaType="java.lang.String"/>
        <result property="fstCrerNm" column="FST_CRER_NM" javaType="java.lang.String"/>
        <result property="fstCreDtm" column="FST_CRE_DTM" javaType="java.lang.String"/>
        <result property="auditId" column="AUDIT_ID" javaType="java.lang.String"/>
        <result property="auditNm" column="AUDIT_NM" javaType="java.lang.String"/>
        <result property="auditDtm" column="AUDIT_DTM" javaType="java.lang.String"/>
        <result property="impoYn" column="IMPO_YN" javaType="java.lang.String"/>
        <result property="boardTit" column="BOARD_TIT" javaType="java.lang.String"/>
        <result property="boardCtt" column="BOARD_CTT" javaType="java.lang.String"/>
        <result property="fileYn" column="FILE_YN" javaType="string"/>
        <collection property="fileList" ofType="com.ai.board.vo.BoardFileVo">
	        <result property="fileId" column="FILE_ID" javaType="java.lang.String"/>
	        <result property="fileNm" column="FILE_NM" javaType="java.lang.String"/>
    	    <result property="fileOgNm" column="FILE_OG_NM" javaType="java.lang.String"/>
        </collection>
    </resultMap>

	<!-- 게시판 상세 조회 -->
	<!-- <select id="selectBoardOne" parameterType="com.ai.board.vo.BoardVo" resultType="com.ai.board.vo.BoardVo"> -->
	<select id="selectBoardOne" parameterType="com.ai.board.vo.BoardVo" resultMap="boardMap">
		SELECT BB.BOARD_ID
			 , F_GET_CODE_NAME('BO001', BB.BOARD_GUBUN) AS BOARD_NM
			 , BB.FST_CRER_ID
			 , IFNULL((SELECT USER_NM FROM CU_USER WHERE USER_ID = BB.FST_CRER_ID), BB.FST_CRER_ID) AS FST_CRER_NM
			 , DATE_FORMAT(BB.FST_CRE_DTM, '%Y-%m-%d %h:%i') AS FST_CRE_DTM
			 , BB.AUDIT_ID
			 , IFNULL((SELECT USER_NM FROM CU_USER WHERE USER_ID = BB.AUDIT_ID), BB.AUDIT_ID) AS AUDIT_NM
		     , DATE_FORMAT(BB.AUDIT_DTM, '%Y-%m-%d %h:%i') AS AUDIT_DTM
			 , BB.IMPO_YN
			 , BB.BOARD_TIT
			 , BB.BOARD_CTT
			 , IF(IFNULL(BBF.FILE_ID, '') = '', 'N', 'Y') AS FILE_YN
			 , BBF.FILE_ID
			 , BBF.FILE_NM
	 		 , BBF.FILE_OG_NM
		  FROM BO_BOARD BB
		  LEFT JOIN BO_BOARD_FILE BBF ON BB.BOARD_ID = BBF.BOARD_ID AND BB.BOARD_GUBUN = BBF.BOARD_GUBUN
	      <!-- LEFT JOIN (
	     	SELECT BOARD_ID
			      , BOARD_GUBUN
			      , FILE_ID
			      , GROUP_CONCAT(FILE_NM ORDER BY FILE_ID ASC SEPARATOR ',')  AS FILE_NM
			      , GROUP_CONCAT(FILE_OG_NM ORDER BY FILE_ID ASC SEPARATOR ',')  AS FILE_OG_NM
			    FROM BO_BOARD_FILE
			    GROUP BY BOARD_ID, BOARD_GUBUN
	      ) BBF ON BB.BOARD_ID = BBF.BOARD_ID AND BB.BOARD_GUBUN = BBF.BOARD_GUBUN -->
		 WHERE 1 = 1
		   AND BB.DEL_YN = 'N'
		   AND BB.BOARD_GUBUN = #{boardGubun}
		   AND BB.BOARD_ID = #{boardId}
	</select>

	<!-- 게시판 PK 조회 -->
	<select id="selectBoardId" parameterType="java.lang.String" resultType="java.lang.String">
		SELECT LPAD(IFNULL(MAX(BOARD_ID), 0) + 1, 8, '0') AS BOARD_ID
		  FROM BO_BOARD
		 WHERE BOARD_GUBUN = #{boardGubun}
	</select>

	<!-- 게시판 파일 등록 -->
	<insert id="insertBordFile" parameterType="com.ai.board.vo.BoardFileVo">
		<selectKey resultType="string" keyProperty="fileId" order="BEFORE">
			SELECT LPAD(IFNULL(MAX(FILE_ID), 0) + 1, 3, '0') AS FILE_ID
			  FROM BO_BOARD_FILE
			 WHERE 1 = 1
			   AND BOARD_ID = #{boardId}
			   AND BOARD_GUBUN = #{boardGubun}
		</selectKey>
		INSERT INTO BO_BOARD_FILE (
			BOARD_ID
			, BOARD_GUBUN
			, FILE_ID
			, FST_CRER_ID
			, FST_CRE_DTM
			, AUDIT_ID
			, AUDIT_DTM
			, FILE_NM
			, FILE_OG_NM
		)
		VALUES (
			#{boardId}
			, #{boardGubun}
			, #{fileId}
			, #{ssLoginId}
			, NOW()
			, #{ssLoginId}
			, NOW()
			, #{fileNm}
			, #{fileOgNm}
		)
	</insert>

	<!-- 게시판 등록 -->
	<insert id="insertBoard" parameterType="com.ai.board.vo.BoardVo">
		INSERT INTO BO_BOARD (
			BOARD_ID
			, BOARD_GUBUN
			, FST_CRER_ID
			, FST_CRE_DTM
			, AUDIT_ID
			, AUDIT_DTM
			, DEL_YN
			, IMPO_YN
			, BOARD_TIT
			, BOARD_CTT
		)
		VALUES (
			#{boardId}
			, #{boardGubun}
			, #{ssLoginId}
			, NOW()
			, #{ssLoginId}
			, NOW()
			, 'N'
			, #{impoYn}
			, #{boardTit}
			, #{boardCtt}
		)
	</insert>

	<!-- 게시판 수정 -->
	<update id="updateBoard" parameterType="com.ai.board.vo.BoardVo">
		UPDATE BO_BOARD
		   SET IMPO_YN = #{impoYn}
			 , BOARD_TIT = #{boardTit}
			 , BOARD_CTT = #{boardCtt}
			 , AUDIT_ID = #{ssLoginId}
			 , AUDIT_DTM = NOW()
		 WHERE 1 = 1
		   AND BOARD_GUBUN = #{boardGubun}
		   AND BOARD_ID = #{boardId}
	</update>

	<!-- 게시판 삭제 -->
	<update id="deleteBoard" parameterType="com.ai.board.vo.BoardVo">
		UPDATE BO_BOARD
		   SET DEL_YN = 'Y'
			 , AUDIT_ID = #{ssLoginId}
			 , AUDIT_DTM = NOW()
		 WHERE 1 = 1
		   AND BOARD_GUBUN = #{boardGubun}
		   AND BOARD_ID = #{boardId}
	</update>

	<!-- 게시판 파일 삭제 -->
	<delete id="deleteBoardFile" parameterType="com.ai.board.vo.BoardFileVo">
		DELETE FROM BO_BOARD_FILE
		 WHERE BOARD_ID = #{boardId}
		   AND BOARD_GUBUN = #{boardGubun}
		   AND FILE_ID = #{fileId}
	</delete>

	<!-- 게시판 파일 조회 -->
	<select id="selectBoardFile" parameterType="com.ai.board.vo.BoardVo" resultType="com.ai.board.vo.BoardFileVo">
		SELECT BOARD_ID
		     , BOARD_GUBUN
		     , FILE_ID
		     , FILE_NM
		     , FILE_OG_NM
		  FROM BO_BOARD_FILE
		 WHERE BOARD_ID = #{boardId}
		   AND BOARD_GUBUN = #{boardGubun}
	</select>

	<!-- 게시판 조회 -->
	<select id="selectBoardListByExternal" resultType="com.ai.board.vo.BoardVo">
		SELECT BB.BOARD_ID
			 , F_GET_CODE_NAME('BO001', BB.BOARD_GUBUN) AS BOARD_NM
			 , BB.FST_CRER_ID
			 , IFNULL((SELECT USER_NM FROM CU_USER WHERE USER_ID = BB.FST_CRER_ID), BB.FST_CRER_ID) AS FST_CRER_NM
			 , DATE_FORMAT(BB.FST_CRE_DTM, '%Y-%m-%d %h:%i') AS FST_CRE_DTM
			 , BB.AUDIT_ID
			 , IFNULL((SELECT USER_NM FROM CU_USER WHERE USER_ID = BB.AUDIT_ID), BB.AUDIT_ID) AS AUDIT_NM
		     , DATE_FORMAT(BB.AUDIT_DTM, '%Y-%m-%d %h:%i') AS AUDIT_DTM
			 , BB.IMPO_YN
			 , BB.BOARD_TIT
			 , BB.BOARD_CTT
			 , IF((SELECT BB.FST_CRE_DTM BETWEEN DATE(DATE_ADD(NOW(), INTERVAL -#{dateControlDay} DAY)) AND NOW() FROM DUAL) = '1', 'Y', 'N') AS NEW_YN
			 , IF(IFNULL(BBF.FILE_ID, '') = '', 'N', 'Y') AS FILE_YN
			 , BBF.FILE_CNT
			 , BBF.FILE_NM
	 		 , BBF.FILE_OG_NM
		  FROM BO_BOARD BB
	      LEFT JOIN (
	     	SELECT BOARD_ID
			      , BOARD_GUBUN
			      , FILE_ID
			      , COUNT(*) AS FILE_CNT
			      , GROUP_CONCAT(FILE_NM ORDER BY FILE_ID ASC SEPARATOR ',')  AS FILE_NM
			      , GROUP_CONCAT(FILE_OG_NM ORDER BY FILE_ID ASC SEPARATOR ',')  AS FILE_OG_NM
			    FROM BO_BOARD_FILE
			    GROUP BY BOARD_ID, BOARD_GUBUN
	      ) BBF ON BB.BOARD_ID = BBF.BOARD_ID AND BB.BOARD_GUBUN = BBF.BOARD_GUBUN
		 WHERE 1 = 1
		   AND BB.DEL_YN = 'N'
		   AND BB.BOARD_GUBUN = #{boardGubun}
		 ORDER BY IF(BB.IMPO_YN = 'Y', 1, 2), FST_CRE_DTM DESC
		 LIMIT 0, #{size}
	</select>

</mapper>